(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{422:function(e,t,r){"use strict";r.r(t);var a=r(7),s=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[e._v("前置阅读文章：")]),e._v(" "),t("ul",[t("li",[t("RouterLink",{attrs:{to:"/user-center/"}},[e._v("《用户体系》")])],1),e._v(" "),t("li",[t("RouterLink",{attrs:{to:"/social-user/"}},[e._v("《三方登录》")])],1)])]),e._v(" "),t("p",[e._v("本文是 "),t("RouterLink",{attrs:{to:"/social-user/"}},[e._v("《三方登录》")]),e._v(" 的延伸，讲解 "),t("a",{attrs:{href:"https://github.com/yudaocode/yudao-mall-uniapp",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("yudao-mall-uniapp")]),t("OutboundLink")],1),e._v(" 商城小程序如何实现微信 "),t("strong",[e._v("小程序")]),e._v(" 订阅消息的功能。对应的官方文档如下：")],1),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message-overview.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("《【开发指南】订阅消息》"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("《【前端】订阅消息》"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/mp-message-management/subscribe-message/deleteMessageTemplate.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("《【服务端】订阅消息》"),t("OutboundLink")],1)])]),e._v(" "),t("h2",{attrs:{id:"_1-小程序准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-小程序准备"}},[e._v("#")]),e._v(" 1. 小程序准备")]),e._v(" "),t("h3",{attrs:{id:"_1-1-模版申请"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-模版申请"}},[e._v("#")]),e._v(" 1.1 模版申请")]),e._v(" "),t("p",[e._v("目前订阅消息，无法使用之前的“测试小程序”，必须进行正式小程序的申请！")]),e._v(" "),t("p",[e._v("申请后，可以在 [微信小程序 -> 功能 -> 订阅消息] 菜单，申请对应的订阅消息模版。如下图所示：")]),e._v(" "),t("p",[t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E6%A8%A1%E7%89%88.png",alt:"订阅消息"}})]),e._v(" "),t("p",[e._v("上图可以看到三个模版，是目前项目已经接入的订阅消息：")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("【商城】订单发货通知：管理员在后台发货后，通知用户\n"),t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E8%AE%A2%E5%8D%95%E5%8F%91%E8%B4%A7%E9%80%9A%E7%9F%A5.png",alt:"订单发货通知"}})])]),e._v(" "),t("li",[t("p",[e._v("【商城】拼团结果通知：用户拼团成功后，通知用户\n"),t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E6%8B%BC%E5%9B%A2%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5.png",alt:"拼团结果通知"}})])]),e._v(" "),t("li",[t("p",[e._v("【支付】充值成功通知：用户充值成功后，通知用户\n"),t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E5%85%85%E5%80%BC%E6%88%90%E5%8A%9F%E9%80%9A%E7%9F%A5.png",alt:"充值成功通知"}})])])]),e._v(" "),t("p",[e._v("而这些模版，我们是无法编辑，而是在【公共模板库】选用后，进入【我的模版】。")]),e._v(" "),t("h3",{attrs:{id:"_1-2-后端配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-后端配置"}},[e._v("#")]),e._v(" 1.2 后端配置")]),e._v(" "),t("p",[e._v("在后端 "),t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/mp-message-management/subscribe-message/sendMessage.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("发送订阅消息"),t("OutboundLink")],1),e._v(" 时，需要传递 "),t("code",[e._v("miniprogram_state")]),e._v(" 参数，用于区分跳转小程序类型：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("developer")]),e._v(" 为开发版")]),e._v(" "),t("li",[t("code",[e._v("trial")]),e._v(" 为体验版")]),e._v(" "),t("li",[t("code",[e._v("formal")]),e._v(" 为正式版")])]),e._v(" "),t("p",[e._v("因此，在 "),t("code",[e._v("application-${profile}.yaml")]),e._v(" 配置文件中，有对应的 "),t("code",[e._v("yudao.wxa-subscribe-message.miniprogram-state")]),e._v(" 配置项，如下图所示：")]),e._v(" "),t("p",[t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE-boot.png",alt:"后端配置"}})]),e._v(" "),t("p",[e._v("一般情况下，如果是开发测试，不用修改，直接使用默认的 "),t("code",[e._v("developer")]),e._v(" 即可。")]),e._v(" "),t("h2",{attrs:{id:"_2-功能演示-代码实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-功能演示-代码实现"}},[e._v("#")]),e._v(" 2. 功能演示 & 代码实现")]),e._v(" "),t("p",[e._v("本小节，我们以【商城】订单发货通知为例，演示如何实现订阅消息的功能。在开始之前，你需要做如下事情：")]),e._v(" "),t("ul",[t("li",[e._v("参考 "),t("a",{attrs:{href:"/quick-start-front"}},[e._v("《快速启动【前端】》")]),e._v(" 文档，把 "),t("code",[e._v("yudao-uniapp-mall")]),e._v(" 商城项目跑起来，并使用 HBuilderX + 微信开发者工具进行调试")]),e._v(" "),t("li",[e._v("参考 "),t("a",{attrs:{href:"/mall/build"}},[e._v("《商城功能开启》")]),e._v(" 文档，开启商城功能")]),e._v(" "),t("li",[e._v("在 [微信小程序 -> 功能 -> 订阅消息] 菜单，配置好“订单发货通知”模版")])]),e._v(" "),t("h3",{attrs:{id:"_2-1-uni-app-获取订阅模版列表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-uni-app-获取订阅模版列表"}},[e._v("#")]),e._v(" 2.1 uni-app 获取订阅模版列表")]),e._v(" "),t("p",[e._v("在 uni-app 打开时，会调用后端的 AppSocialUserController 的 "),t("code",[e._v("#getSubscribeTemplateList()")]),e._v(" 方法，获取订阅消息模版列表。")]),e._v(" "),t("p",[e._v("目的是，uni-app 在调用 "),t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("wx.requestSubscribeMessage(Object object)")]),t("OutboundLink")],1),e._v(" 发起订阅消息时，需要传递 "),t("code",[e._v("tmplIds")]),e._v(" 消息模版的编号。")]),e._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[e._v("友情提示：")]),e._v(" "),t("p",[e._v("由于暂时没做微信小程序的订阅消息的模版管理，所以暂时通过它的模版名称来匹配的。算是约定大于配置吧~")]),e._v(" "),t("p",[e._v("不过因为小程序的订阅消息模版是只能 "),t("strong",[e._v("选用")]),e._v("，标题是固定的，所以这个约定是可行的。")])]),e._v(" "),t("h3",{attrs:{id:"_2-2-uni-app-发起订阅消息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-uni-app-发起订阅消息"}},[e._v("#")]),e._v(" 2.2 uni-app 发起订阅消息")]),e._v(" "),t("p",[e._v("第一步，在 uni-app 中，下单并完成支付，然后会进入支付成功页。如下图所示：")]),e._v(" "),t("p",[t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E9%A1%B5.png",alt:"支付成功页"}})]),e._v(" "),t("p",[e._v("第二步，点击【立即订阅】按钮，发起对“订单发货通知”的订阅消息。如下图所示：")]),e._v(" "),t("p",[t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E5%8F%91%E8%B5%B7%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF.png",alt:"发起订阅消息"}})]),e._v(" "),t("p",[e._v("它的实现，通过调用项目的 "),t("code",[e._v("sheep/platform/provider/wechat/miniProgram.js")]),e._v(" 的 "),t("code",[e._v("#subscribeMessage(...)")]),e._v(" 方法，从而调用微信的 "),t("code",[e._v("wx.requestSubscribeMessage(Object object)")]),e._v(" 方法，发起订阅消息的请求。")]),e._v(" "),t("h3",{attrs:{id:"_2-3-后端发送订阅消息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-后端发送订阅消息"}},[e._v("#")]),e._v(" 2.3 后端发送订阅消息")]),e._v(" "),t("p",[e._v("第一步，在管理后台，点击 [商城系统 -> 订单中心 -> 订单列表] 菜单，找到对应的订单，点击【发货】按钮，发起对订单的发货操作。如下图所示：")]),e._v(" "),t("p",[t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E8%AE%A2%E5%8D%95%E5%8F%91%E8%B4%A7.png",alt:"订单发货"}})]),e._v(" "),t("p",[e._v("它的内部，通过调用项目的 SocialClientApi 的 "),t("code",[e._v("#sendWxaSubscribeMessage(...)")]),e._v(" 方法，从而调用微信的 "),t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/mp-message-management/subscribe-message/sendMessage.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("发送订阅消息"),t("OutboundLink")],1),e._v(" 接口，发送订阅消息的请求。")]),e._v(" "),t("p",[e._v("第二步，拿出手机微信（PC 电脑上看不到），在【服务通知】中，可以看到对应的订阅消息。如下图所示：")]),e._v(" "),t("p",[t("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/%E6%9C%8D%E5%8A%A1%E9%80%9A%E7%9F%A5.png",alt:"服务通知"}})]),e._v(" "),t("p",[e._v("如果没有收到订阅消息，可以在 IDEA 控制台，搜 "),t("code",[e._v("[sendSubscribeMessage]")]),e._v(" 关键字，查看是否有异常日志输出。")]),e._v(" "),t("h2",{attrs:{id:"_3-其它业务如何接入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-其它业务如何接入"}},[e._v("#")]),e._v(" 3. 其它业务如何接入？")]),e._v(" "),t("p",[e._v("参考上述小节的内容：")]),e._v(" "),t("ul",[t("li",[e._v("第一步，在 uni-app 项目中，需要调用项目的 "),t("code",[e._v("sheep/platform/provider/wechat/miniProgram.js")]),e._v(" 的 "),t("code",[e._v("#subscribeMessage(...)")]),e._v(" 方法，发起订阅")]),e._v(" "),t("li",[e._v("第二步，在后端项目中，需要调用 SocialClientApi 的 "),t("code",[e._v("#sendWxaSubscribeMessage(...)")]),e._v(" 方法，发送订阅消息")])]),e._v(" "),t("p",[e._v("当然，肯定需要在微信小程序那，配置对应的订阅消息模版。")])])}),[],!1,null,null,null);t.default=s.exports}}]);