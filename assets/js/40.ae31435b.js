(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{369:function(t,a,s){"use strict";s.r(a);var n=s(7),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("项目支持将文件上传到三类存储器：")]),t._v(" "),a("ol",[a("li",[t._v("兼容 S3 协议的对象存储：支持 MinIO、腾讯云 COS、七牛云 Kodo、华为云 OBS、亚马逊 S3 等等。")]),t._v(" "),a("li",[t._v("磁盘存储：本地、FTP 服务器、SFTP 服务器。")]),t._v(" "),a("li",[t._v("数据库存储：MySQL、Oracle、PostgreSQL、SQL Server 等等。")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("技术选型？")]),t._v(" "),a("ul",[a("li",[t._v("优先，✔ 推荐方案 1。如果无法使用云服务，可以自己搭建一个 MinIO 服务。参见 "),a("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/MinIO/?yudao",target:"_blank",rel:"noopener noreferrer"}},[t._v("《芋道 Spring Boot 对象存储 MinIO 入门 》"),a("OutboundLink")],1),t._v(" 文章。")]),t._v(" "),a("li",[t._v("其次，推荐方案 3。数据库的主从机制可以实现高可用，备份也方便，少量小文件问题不大。")]),t._v(" "),a("li",[t._v("最后，× 不推荐方案 2。主要是实现高可用比较困难，无法实现故障转移。")])])]),t._v(" "),a("h2",{attrs:{id:"_1-快速入门"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-快速入门"}},[t._v("#")]),t._v(" 1. 快速入门")]),t._v(" "),a("p",[t._v("本小节，我们来添加个文件配置，并使用它上传下载文件。")]),t._v(" "),a("h3",{attrs:{id:"_1-1-新增配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-新增配置"}},[t._v("#")]),t._v(" 1.1 新增配置")]),t._v(" "),a("p",[t._v("① 打开 [基础设施 -> 文件管理 -> 文件配置] 菜单，进入文件配置的界面。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/01.png",alt:"文件配置"}})]),t._v(" "),a("p",[t._v("② 点击 [新增] 按钮，选择存储器为【S3 对象存储器】，并填写七牛云的配置。如下图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/02.png",alt:"S3 对象存储器"}})]),t._v(" "),a("ul",[a("li",[t._v("节点地址：s3.cn-south-1.qiniucs.com")]),t._v(" "),a("li",[t._v("存储 bucket：ruoyi-vue-pro")]),t._v(" "),a("li",[t._v("accessKey：3TvrJ70gl2Gt6IBe7_IZT1F6i_k0iMuRtyEv4EyS")]),t._v(" "),a("li",[t._v("accessSecret：wd0tbVBYlp0S-ihA8Qg2hPLncoP83wyrIq24OZuY")]),t._v(" "),a("li",[t._v("自定义域名：http://test.yudao.iocoder.cn")])]),t._v(" "),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[t._v("友善的眼神！")]),t._v(" "),a("p",[t._v("上述七牛云的配置，是艿艿为了大家方便体验，请勿在测试或生产环境体验。")]),t._v(" "),a("p",[t._v("也就是说，测试或生产环境下，请换成自己的七牛、阿里云、腾讯云等等的配置！！！")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("疑问：MinIO 做了 Nginx 反向代理（提供了独立域名），需要怎么配置？")]),t._v(" "),a("p",[t._v("可见 "),a("a",{attrs:{href:"https://t.zsxq.com/wKmMW",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://t.zsxq.com/wKmMW"),a("OutboundLink")],1),t._v(" 帖子，有 2 种解决方案。")])]),t._v(" "),a("p",[t._v("③ 添加完后，点击该配置所在行的 [测试] 按钮，测试配置是否正确。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/03.png",alt:"测试配置"}})]),t._v(" "),a("p",[t._v("④ 测试通过后，点击该配置所在行的 [主配置] 按钮，设置它为"),a("strong",[t._v("默认")]),t._v("的配置，后续使用它进行文件的上传。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/07.png",alt:"测试配置"}})]),t._v(" "),a("h3",{attrs:{id:"_1-2-上传文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-上传文件"}},[t._v("#")]),t._v(" 1.2 上传文件")]),t._v(" "),a("p",[t._v("① 点击 [基础设施 -> 文件管理 -> 文件列表] 菜单，进入文件列表的界面。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/04.png",alt:"文件列表"}})]),t._v(" "),a("p",[t._v("② 点击 [上传文件] 按钮，选择要上传的文件。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/05.png",alt:"文件列表"}})]),t._v(" "),a("p",[t._v("③ 上传完成后，如果想要删除，可点击该文件所在行的 [删除] 按钮。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/06.png",alt:"文件列表"}})]),t._v(" "),a("h2",{attrs:{id:"_2-文件上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-文件上传"}},[t._v("#")]),t._v(" 2. 文件上传")]),t._v(" "),a("p",[t._v("项目提供了 2 种文件上传的方式，分别适合前端、后端使用。")]),t._v(" "),a("h3",{attrs:{id:"_2-1-方式一-前端上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-方式一-前端上传"}},[t._v("#")]),t._v(" 2.1 方式一：前端上传")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-infra/yudao-module-infra-biz/src/main/java/cn/iocoder/yudao/module/infra/controller/admin/file/FileController.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("FileController"),a("OutboundLink")],1),t._v(" 提供了 "),a("code",[t._v("/admin-api/infra/file/upload")]),t._v(" RESTful API，用于前端直接上传文件。")]),t._v(" "),a("div",{staticClass:"language-Java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// FileController.java")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PostMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/upload"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Operation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("summary "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"上传文件"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommonResult")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uploadFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FileUploadReqVO")]),t._v(" uploadReqVO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MultipartFile")]),t._v(" file "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" uploadReqVO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" uploadReqVO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fileService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getOriginalFilename")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IoUtil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readBytes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInputStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("前端上传文件的代码如何实现，可见：")]),t._v(" "),a("ul",[a("li",[t._v("文件列表，文件上传 "),a("a",{attrs:{href:"https://github.com/yudaocode/yudao-ui-admin-vue2/blob/master/src/views/infra/file/index.vue#L59-L76",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("index.vue")]),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("个人中心，头像修改 "),a("a",{attrs:{href:"https://github.com/yudaocode/yudao-ui-admin-vue2/blob/master/src/views/system/user/profile/userAvatar.vue#L122-L135",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("userAvatar.vue")]),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"_2-2-方式二-后端上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-方式二-后端上传"}},[t._v("#")]),t._v(" 2.2 方式二：后端上传")]),t._v(" "),a("p",[a("code",[t._v("yudao-module-infra")]),t._v(" 的 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-infra/yudao-module-infra-api/src/main/java/cn/iocoder/yudao/module/infra/api/file/FileApi.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("FileApi"),a("OutboundLink")],1),t._v(" 提供了 "),a("code",[t._v("#createFile(...)")]),t._v(" 方法，用于后端需要上传文件的逻辑。")]),t._v(" "),a("div",{staticClass:"language-Java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// FileApi.java")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * 保存文件，并返回文件的访问路径\n *\n * @param path 文件路径\n * @param content 文件内容\n * @return 文件路径\n */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("例如说，个人中心修改头像时，需要进行头像的上传。如下图所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/08.png",alt:"后端上传"}})]),t._v(" "),a("p",[t._v("注意，需要使用到后端上传的 Maven 模块，需要引入 "),a("code",[t._v("yudao-module-infra-api")]),t._v(" 依赖。例如说 "),a("code",[t._v("yudao-module-system-biz")]),t._v(" 模块的 "),a("code",[t._v("pom.xml")]),t._v(" 文件，引用如下：")]),t._v(" "),a("div",{staticClass:"language-XML extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("cn.iocoder.boot"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("yudao-module-infra-api"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("${revision}"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("h2",{attrs:{id:"_3-文件下载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-文件下载"}},[t._v("#")]),t._v(" 3. 文件下载")]),t._v(" "),a("p",[t._v("文件上传成功后，返回的是"),a("strong",[t._v("完整的 URL 访问路径")]),t._v("，例如说 "),a("a",{attrs:{href:"http://test.yudao.iocoder.cn/822aebded6e6414e912534c6091771a4.jpg",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://test.yudao.iocoder.cn/822aebded6e6414e912534c6091771a4.jpg"),a("OutboundLink")],1),t._v(" 。")]),t._v(" "),a("p",[t._v("不同的文件存储器，返回的 URL 路径的规则是不同的：")]),t._v(" "),a("p",[t._v("① 当存储器是【S3 对象存储】时，支持 HTTP 访问，所以直接使用 S3 对象存储返回的 URL 路径即可。")]),t._v(" "),a("p",[t._v("② 当存储器是【数据库】【本地磁盘】等时，它们只支持存储，所以需要 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-infra/yudao-module-infra-biz/src/main/java/cn/iocoder/yudao/module/infra/controller/admin/file/FileController.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("FileController"),a("OutboundLink")],1),t._v(" 提供的 "),a("code",[t._v("/admin-api/infra/file/{configId}/get/{path}")]),t._v(" RESTful API，读取文件内容后返回。")]),t._v(" "),a("div",{staticClass:"language-Java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// FileController.java")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/{configId}/get/**"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PermitAll")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Operation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("summary "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"下载文件"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Parameter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"configId"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" description "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"配置编号"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  required "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFileContent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletRequest")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                           "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletResponse")]),t._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                           "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PathVariable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"configId"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" configId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取请求的路径")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StrUtil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("subAfter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRequestURI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/get/"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StrUtil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEmpty")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IllegalArgumentException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"结尾的 path 路径必须传递"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 读取内容")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" content "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fileService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFileContent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("configId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("warn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[getFileContent][configId({}) path({}) 文件不存在]"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" configId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setStatus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpStatus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NOT_FOUND")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServletUtils")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeAttachment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"_4-文件客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-文件客户端"}},[t._v("#")]),t._v(" 4. 文件客户端")]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("yudao-module-infra-biz")]),t._v(" 模块中，它的 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-infra/yudao-module-infra-biz/src/main/java/cn/iocoder/yudao/module/infra/framework/file/package-info.java",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("framework/file")]),a("OutboundLink")],1),t._v(" 包下，定义了 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-infra/yudao-module-infra-biz/src/main/java/cn/iocoder/yudao/module/infra/framework/file/core/client/FileClient.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("FileClient"),a("OutboundLink")],1),t._v(" 接口，抽象了文件客户端的方法。代码如下所示：")]),t._v(" "),a("div",{staticClass:"language-Java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FileClient")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * 获得客户端编号\n     *\n     * @return 客户端编号\n     */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * 上传文件\n     *\n     * @param content 文件流\n     * @param path 相对路径\n     * @return 完整路径，即 HTTP 访问地址\n     */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("upload")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * 删除文件\n     *\n     * @param path 相对路径\n     */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("delete")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * 获得文件的内容\n     *\n     * @param path 相对路径\n     * @return 文件的内容\n     */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getContent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("FileClient 有 5 个实现类，使用不同存储器进行文件的上传与下载。UML 类图如所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/09.png",alt:""}})]),t._v(" "),a("p",[t._v("文件上传的调用的 UML 时序图如下所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/10.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"_5-s3-对象存储的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-s3-对象存储的配置"}},[t._v("#")]),t._v(" 5. S3 对象存储的配置")]),t._v(" "),a("p",[t._v("做的不错的云存储服务，都是兼容 S3 协议的。如何获取对应的 S3 配置，艿艿整理到了 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-infra/yudao-module-infra-biz/src/main/java/cn/iocoder/yudao/module/infra/framework/file/core/client/FileClientConfig.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("S3FileClientConfig"),a("OutboundLink")],1),t._v(" 配置类。")]),t._v(" "),a("p",[t._v("有一点要注意，云存储服务的 Bucket 需要设置为"),a("strong",[t._v("公共读")]),t._v("，不然 URL 无法访问到文件。")]),t._v(" "),a("p",[t._v("并且，最好使用自定义域名，方便迁移到不同的云存储服务。")]),t._v(" "),a("h2",{attrs:{id:"_6-前端直传-s3-存储【推荐】"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-前端直传-s3-存储【推荐】"}},[t._v("#")]),t._v(" 6. 前端直传 S3 存储【推荐】")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("友情提示：目前仅 yudao-ui-admin-vue3 前端项目支持，Vue3 + Element Plus 版本")])]),t._v(" "),a("p",[t._v("前面小节的文件上传，都是 "),a("code",[t._v("前端 => 后端 => S3 存储器")]),t._v(" 的方式。这种方式，有一个问题，就是文件的流量会经过后端，如果后端的服务器带宽不够，就会影响文件的上传速度。例如说：上传文件有 10MB，后端服务器带宽只有 1MB，那么上传文件就需要 10 秒。如果多个人上传文件，就会导致后端服务器的带宽被占满。")]),t._v(" "),a("p",[t._v("因此，更加推荐采用 "),a("code",[t._v("前端 => S3 存储器")]),t._v(" 的方式，即前端直传 S3 存储器。这样，文件的流量不会经过后端，上传速度会更快。例如说：上传文件有 10MB，用户的带宽有 100MB，那么上传文件就需要 0.1 秒。")]),t._v(" "),a("p",[t._v("下面，我们以七牛云的配置为例，演示如何在前端直传 S3 存储器。当然，其它阿里云、腾讯云、华为云等等都是类似的。")]),t._v(" "),a("h3",{attrs:{id:"_6-1-新增-s3-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-新增-s3-配置"}},[t._v("#")]),t._v(" 6.1 新增 S3 配置")]),t._v(" "),a("p",[t._v("在 [基础设施 -> 文件管理 -> 文件配置] 菜单，新增一个 S3 对象存储器的配置，填写七牛云的配置，并设置它为"),a("strong",[t._v("默认")]),t._v("的配置。结果如下图所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0-%E6%96%B0%E5%A2%9E%E9%85%8D%E7%BD%AE.png",alt:"新增配置"}})]),t._v(" "),a("p",[t._v("实际上，这个步骤和「2.1 新增步骤」是一样的哈！")]),t._v(" "),a("h3",{attrs:{id:"_6-2-配置-s3-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-配置-s3-跨域"}},[t._v("#")]),t._v(" 6.2 配置 S3 跨域")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("友情提示：这个步骤，是为了解决前端直传 S3 存储器的跨域问题。")])]),t._v(" "),a("ul",[a("li",[t._v("七牛云的跨域配置：参见 "),a("a",{attrs:{href:"https://developer.qiniu.com/kodo/6094/set-cors",target:"_blank",rel:"noopener noreferrer"}},[t._v("《设置跨域资源共享 》"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("阿里云的跨域配置：参见 "),a("a",{attrs:{href:"https://developer.aliyun.com/article/1168029",target:"_blank",rel:"noopener noreferrer"}},[t._v("《阿里云 OSS 设置跨域访问》"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("腾讯云的跨域配置：参见 "),a("a",{attrs:{href:"https://cloud.tencent.com/document/product/436/13318",target:"_blank",rel:"noopener noreferrer"}},[t._v("《设置跨域访问》"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("如下是七牛云的跨域配置截图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0-%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE.png",alt:"跨域配置"}})]),t._v(" "),a("h3",{attrs:{id:"_6-3-配置前端直传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-配置前端直传"}},[t._v("#")]),t._v(" 6.3 配置前端直传")]),t._v(" "),a("p",[t._v("修改 "),a("code",[t._v("yudao-ui-admin-vue3")]),t._v(" 前端项目的配置文件的 "),a("code",[t._v("VITE_UPLOAD_TYPE")]),t._v(" 为 "),a("code",[t._v("client")]),t._v(" 前端直传模式。例如说，你是本地环境，则修改 "),a("code",[t._v(".env.local")]),t._v(" 文件，如下图所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0-%E5%89%8D%E7%AB%AF%E9%85%8D%E7%BD%AE.png",alt:"前端配置"}})]),t._v(" "),a("h3",{attrs:{id:"_6-4-测试上传文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-测试上传文件"}},[t._v("#")]),t._v(" 6.4 测试上传文件")]),t._v(" "),a("p",[t._v("点击 [基础设施 -> 文件管理 -> 文件列表] 菜单，测试上传文件。结果如下图所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0-%E6%B5%8B%E8%AF%95%E4%B8%8A%E4%BC%A0.png",alt:"测试上传"}})]),t._v(" "),a("p",[t._v("具体的代码实现：")]),t._v(" "),a("ul",[a("li",[t._v("前端："),a("code",[t._v("src/components/UploadFile/src/useUpload.ts")]),t._v(" 文件")]),t._v(" "),a("li",[t._v("后端：FileController 的 "),a("code",[t._v("/presigned-url")]),t._v(" RESTful API")])])])}),[],!1,null,null,null);a.default=e.exports}}]);