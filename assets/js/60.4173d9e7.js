(window.webpackJsonp=window.webpackJsonp||[]).push([[60],{390:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[t("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-mq/",target:"_blank",rel:"noopener noreferrer"}},[t("code",[s._v("yudao-spring-boot-starter-mq")]),t("OutboundLink")],1),s._v(" 技术组件，基于 Redis 实现分布式消息队列：")]),s._v(" "),t("ul",[t("li",[s._v("使用 "),t("a",{attrs:{href:"http://www.redis.cn/topics/streams-intro.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Stream"),t("OutboundLink")],1),s._v(" 特性，提供【集群】消费的能力。")]),s._v(" "),t("li",[s._v("使用 "),t("a",{attrs:{href:"http://www.redis.cn/topics/pubsub.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Pub/Sub"),t("OutboundLink")],1),s._v(" 特性，提供【广播】消费的能力。")])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("疑问：什么是【广播】消费？什么是【集群】消费？")]),s._v(" "),t("p",[s._v("参见"),t("a",{attrs:{href:"https://help.aliyun.com/zh/apsaramq-for-rocketmq/cloud-message-queue-rocketmq-4-x-series/developer-reference/clustering-consumption-and-broadcasting-consumption",target:"_blank",rel:"noopener noreferrer"}},[s._v("《阿里云 —— 集群消费和广播消费 》"),t("OutboundLink")],1),s._v("文档")])]),s._v(" "),t("h2",{attrs:{id:"_1-集群消费"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-集群消费"}},[s._v("#")]),s._v(" 1. 集群消费")]),s._v(" "),t("p",[s._v("集群消费，是指消息发送到 Redis 时，有且只会被一个消费者（应用 JVM 实例）收到，然后消费成功。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/Redis/%E9%9B%86%E7%BE%A4%E6%B6%88%E8%B4%B9.png",alt:"集群消费"}})]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("友情提示：")]),s._v(" "),t("p",[s._v("如果你需要使用到【集群】消费，必须使用 Redis 5.0.0 以上版本，因为 Stream 特性是在该版本之后才引入噢！")])]),s._v(" "),t("h3",{attrs:{id:"_1-1-使用场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-使用场景"}},[s._v("#")]),s._v(" 1.1 使用场景")]),s._v(" "),t("p",[s._v("集群消费在项目中的使用场景，主要是提供可靠的、可堆积的异步任务的能力。例如说：")]),s._v(" "),t("ul",[t("li",[s._v("短信模块，使用它"),t("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/mq/consumer/sms/SmsSendConsumer.java",target:"_blank",rel:"noopener noreferrer"}},[s._v("异步"),t("OutboundLink")],1),s._v("发送短信。")]),s._v(" "),t("li",[s._v("邮件模块，使用它"),t("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/mq/consumer/mail/MailSendConsumer.java",target:"_blank",rel:"noopener noreferrer"}},[s._v("异步"),t("OutboundLink")],1),s._v("发送邮件。")])]),s._v(" "),t("p",[s._v("相比 "),t("a",{attrs:{href:"/async-task"}},[s._v("《开发指南 —— 异步任务》")]),s._v(" 来说，Spring Async 在 JVM 实例重启时，会导致未执行完的任务丢失。而集群消费，因为消息是存储在 Redis 中，所以不会存在该问题。")]),s._v(" "),t("h3",{attrs:{id:"_1-2-实现源码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-实现源码"}},[s._v("#")]),s._v(" 1.2 实现源码")]),s._v(" "),t("p",[s._v("集群消费基于 Redis Stream 实现：")]),s._v(" "),t("ul",[t("li",[s._v("实现 AbstractRedisStreamMessage 抽象类，定义【集群】消息。")]),s._v(" "),t("li",[s._v("使用 RedisMQTemplate 的 "),t("code",[s._v("#send(message)")]),s._v(" 方法，发送消息。")]),s._v(" "),t("li",[s._v("实现 AbstractRedisStreamMessageListener 接口，消费消息。")])]),s._v(" "),t("p",[s._v("最终使用 YudaoRedisMQAutoConfiguration 配置类，扫描所有的 AbstractRedisStreamMessageListener 监听器，初始化对应的消费者。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/Redis/YudaoRedisMQAutoConfiguration.png",alt:"YudaoRedisMQAutoConfiguration"}})]),s._v(" "),t("h3",{attrs:{id:"_1-3-实战案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-实战案例"}},[s._v("#")]),s._v(" 1.3 实战案例")]),s._v(" "),t("p",[s._v("以【短信发送】举例子，改造使用 Redis 作为消息队列，同时也是讲解集群消费的使用。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/Redis/%E9%9B%86%E7%BE%A4%E6%B6%88%E8%B4%B9-%E6%A1%88%E4%BE%8B.png",alt:"实战案例"}})]),s._v(" "),t("h4",{attrs:{id:"_1-3-0-引入依赖"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-0-引入依赖"}},[s._v("#")]),s._v(" 1.3.0 引入依赖")]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("yudao-module-system-biz")]),s._v(" 模块中，引入 "),t("code",[s._v("yudao-spring-boot-starter-mq")]),s._v(" 技术组件。如下所示：")]),s._v(" "),t("div",{staticClass:"language-XML extra-class"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("cn.iocoder.boot"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("yudao-spring-boot-starter-mq"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])]),t("h4",{attrs:{id:"_1-3-1-message-消息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-message-消息"}},[s._v("#")]),s._v(" 1.3.1 Message 消息")]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("message")]),s._v(" 包下，修改 SmsSendMessage 类，短信发送消息。代码如下：")]),s._v(" "),t("div",{staticClass:"language-Java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Data")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SmsSendMessage")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AbstractRedisStreamMessage")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 重点：需要继承 AbstractRedisStreamMessage 类")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 短信日志编号\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@NotNull")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"短信日志编号不能为空"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Long")]),s._v(" logId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 手机号\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@NotNull")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"手机号不能为空"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" mobile"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 短信渠道编号\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@NotNull")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"短信渠道编号不能为空"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Long")]),s._v(" channelId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 短信 API 的模板编号\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@NotNull")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"短信 API 的模板编号不能为空"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" apiTemplateId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 短信模板参数\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("KeyValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" templateParams"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("h4",{attrs:{id:"_1-3-2-smsproducer-生产者"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-smsproducer-生产者"}},[s._v("#")]),s._v(" 1.3.2 SmsProducer 生产者")]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("producer")]),s._v(" 包下，修改 SmsProducer 类，Sms 短信相关消息的生产者。代码如下：")]),s._v(" "),t("div",{staticClass:"language-Java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Slf4j")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Component")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SmsProducer")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Resource")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RedisMQTemplate")]),s._v(" redisMQTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 重点：注入 RedisMQTemplate 对象")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 发送 {@link SmsSendMessage} 消息\n     *\n     * @param logId 短信日志编号\n     * @param mobile 手机号\n     * @param channelId 渠道编号\n     * @param apiTemplateId 短信模板编号\n     * @param templateParams 短信模板参数\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sendSmsSendMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Long")]),s._v(" logId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" mobile"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Long")]),s._v(" channelId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" apiTemplateId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("KeyValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" templateParams"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SmsSendMessage")]),s._v(" message "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SmsSendMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setLogId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("logId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMobile")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mobile"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setChannelId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("channelId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setApiTemplateId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("apiTemplateId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTemplateParams")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("templateParams"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        redisMQTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 重点：使用 RedisMQTemplate 发送消息")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("h4",{attrs:{id:"_1-3-3-smssendconsumer-消费者"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-3-smssendconsumer-消费者"}},[s._v("#")]),s._v(" 1.3.3 SmsSendConsumer 消费者")]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("consumer")]),s._v(" 包下，修改 SmsSendConsumer 类，SmsSendMessage 的消费者。代码如下：")]),s._v(" "),t("div",{staticClass:"language-Java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Component")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Slf4j")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SmsSendConsumer")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AbstractRedisStreamMessageListener")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SmsSendMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 重点：继承 AbstractRedisStreamMessageListener 类，并填写对应的 Message 类")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Resource")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SmsSendService")]),s._v(" smsSendService"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 重点：实现 onMessage 方法")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("onMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SmsSendMessage")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[onMessage][消息内容({})]"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        smsSendService"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("doSendSms")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("h4",{attrs:{id:"_1-3-4-简单测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-4-简单测试"}},[s._v("#")]),s._v(" 1.3.4 简单测试")]),s._v(" "),t("p",[s._v("① Debug 启动后端项目，可以在 SmsProducer 和 SmsSendConsumer 上面打上断点，稍微调试下。")]),s._v(" "),t("p",[s._v("② 打开 "),t("code",[s._v("SmsTemplateController.http")]),s._v(" 文件，使用 IDEA httpclient 发起请求，发送短信。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/%E5%86%85%E5%AD%98/%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95.png",alt:"简单测试"}})]),s._v(" "),t("p",[s._v("如果 IDEA 控制台看到 "),t("code",[s._v("[onMessage][消息内容")]),s._v(" 日志内容，说明消息的发送和消费成功。")]),s._v(" "),t("h2",{attrs:{id:"_2-广播消费"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-广播消费"}},[s._v("#")]),s._v(" 2. 广播消费")]),s._v(" "),t("p",[s._v("广播消费，是指消息发送到 Redis 时，所有消费者（应用 JVM 实例）收到，然后消费成功。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/Redis/%E5%B9%BF%E6%92%AD%E6%B6%88%E8%B4%B9.png",alt:"集群消费"}})]),s._v(" "),t("h3",{attrs:{id:"_2-1-使用场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-使用场景"}},[s._v("#")]),s._v(" 2.1 使用场景")]),s._v(" "),t("p",[s._v("例如说，在应用中，缓存了数据字典等配置表在内存中，可以通过 Redis 广播消费，实现每个应用节点都消费消息，刷新本地内存的缓存。")]),s._v(" "),t("p",[s._v("又例如说，我们基于 WebSocket 实现了 IM 聊天，在我们给用户主动发送消息时，因为我们不知道用户连接的是哪个提供 WebSocket 的应用，所以可以通过 Redis 广播消费。每个应用判断当前用户是否是和自己提供的 WebSocket 服务连接，如果是，则推送消息给用户。")]),s._v(" "),t("h3",{attrs:{id:"_2-2-实现源码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-实现源码"}},[s._v("#")]),s._v(" 2.2 实现源码")]),s._v(" "),t("p",[s._v("广播消费基于 Redis Pub/Sub 实现：")]),s._v(" "),t("ul",[t("li",[s._v("实现 AbstractChannelMessage 抽象类，定义【广播】消息。")]),s._v(" "),t("li",[s._v("使用 RedisMQTemplate 的 "),t("code",[s._v("#send(message)")]),s._v(" 方法，发送消息。")]),s._v(" "),t("li",[s._v("实现 AbstractRedisChannelMessageListener 接口，消费消息。")])]),s._v(" "),t("p",[s._v("最终使用 YudaoRedisMQAutoConfiguration 配置类，扫描所有的 AbstractRedisChannelMessageListener 监听器，初始化对应的消费者。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/Redis/YudaoRedisMQAutoConfiguration-02.png",alt:"YudaoRedisMQAutoConfiguration"}})]),s._v(" "),t("h3",{attrs:{id:"_2-3-实战案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-实战案例"}},[s._v("#")]),s._v(" 2.3 实战案例")]),s._v(" "),t("p",[s._v("参见 "),t("a",{attrs:{href:"/local-cache"}},[s._v("《开发指南 —— 本地缓存》")])])])}),[],!1,null,null,null);t.default=e.exports}}]);