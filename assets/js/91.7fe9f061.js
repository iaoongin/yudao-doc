(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{421:function(t,_,v){"use strict";v.r(_);var e=v(7),a=Object(e.a)({},(function(){var t=this,_=t._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("前置阅读文章：")]),t._v(" "),_("ul",[_("li",[_("RouterLink",{attrs:{to:"/user-center/"}},[t._v("《用户体系》")])],1),t._v(" "),_("li",[_("RouterLink",{attrs:{to:"/social-user/"}},[t._v("《三方登录》")])],1)])]),t._v(" "),_("p",[t._v("本文是 "),_("RouterLink",{attrs:{to:"/social-user/"}},[t._v("《三方登录》")]),t._v(" 的延伸，讲解 "),_("a",{attrs:{href:"https://github.com/yudaocode/yudao-mall-uniapp",target:"_blank",rel:"noopener noreferrer"}},[_("code",[t._v("yudao-mall-uniapp")]),_("OutboundLink")],1),t._v(" 商城小程序如何实现微信 "),_("strong",[t._v("公众号")]),t._v(" 登录的功能。")],1),t._v(" "),_("h2",{attrs:{id:"_1-公众号准备"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_1-公众号准备"}},[t._v("#")]),t._v(" 1. 公众号准备")]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("友情提示：")]),t._v(" "),_("p",[t._v("本文，我们以“测试公众号”举例子，方便大家操作，认证一个公众号太难了！！！")])]),t._v(" "),_("p",[t._v("① 参考 "),_("a",{attrs:{href:"https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信公众平台接口测试帐号申请"),_("OutboundLink")],1),t._v(" 链接，申请一个测试公众号。")]),t._v(" "),_("p",[t._v("② 将 "),_("code",[t._v("appID")]),t._v(" 和 "),_("code",[t._v("appSecret")]),t._v(" 配置，设置到后端项目 "),_("code",[t._v("application-local.yaml")]),t._v(" 的 "),_("code",[t._v("wx.mp")]),t._v(" 配置项中。如下图所示：")]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/%E6%B5%8B%E8%AF%95%E5%85%AC%E4%BC%97%E5%8F%B7-%E5%AF%86%E9%92%A5.png",alt:"测试公众号 - 密钥"}})]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E9%A1%B9.png",alt:" 配置项"}})]),t._v(" "),_("p",[t._v("③ 修改“JS接口安全域名”，设置为前端的访问地址。例如说，现在本地是 "),_("code",[t._v("http://127.0.0.1:3000")]),t._v("。如下图所示：")]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/JS%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8%E5%9F%9F%E5%90%8D.png",alt:"JS 接口安全域名.png"}})]),t._v(" "),_("p",[t._v("注意：自己需要关注下自己的测试公众号！！！")]),t._v(" "),_("p",[t._v("④ 修改“网页授权获取用户基本信息”，设置为前端的访问地址。例如说，现在本地是 "),_("code",[t._v("http://127.0.0.1:3000")]),t._v("。如下图所示：")]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF.png",alt:"网页授权获取用户基本信息"}})]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("补充说明：如果你是正式的公众号，需要额外看下这部分的内容：")]),t._v(" "),_("p",[t._v("① 设置“IP白名单”，在公众号的 [设置与开发 - 安全中心] 菜单，如下图所示：")]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/IP%E7%99%BD%E5%90%8D%E5%8D%95.png",alt:"IP 白名单"}})]),t._v(" "),_("p",[t._v("② 在公众号的 [设置与开发 - 公众号设置] 菜单，设置“JS接口安全域名”、“JS接口安全域名”、“网页授权域名”，如下图所示：")]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/%E5%85%AC%E4%BC%97%E5%8F%B7%E8%AE%BE%E7%BD%AE.png",alt:"公众号设置"}})]),t._v(" "),_("ul",[_("li",[t._v("设置时，需要外网可访问，可以需要使用 "),_("RouterLink",{attrs:{to:"/natapp/"}},[t._v("natapp")]),t._v(" 进行内网穿透")],1),t._v(" "),_("li",[t._v("上图的 "),_("code",[t._v("MP_verify_XXXXXXXXXXXXXXXX.txt")]),t._v(" 文件，可以直接放在 "),_("code",[t._v("yudao-mall-uniapp")]),t._v(" 商城项目的根目录")])])]),t._v(" "),_("h2",{attrs:{id:"_2-代码实现"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-代码实现"}},[t._v("#")]),t._v(" 2. 代码实现")]),t._v(" "),_("h3",{attrs:{id:"_2-1-项目启动"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-项目启动"}},[t._v("#")]),t._v(" 2.1 项目启动")]),t._v(" "),_("p",[t._v("① 参考 "),_("RouterLink",{attrs:{to:"/quick-start-front/"}},[t._v("《快速启动【前端】》")]),t._v(" 文档的「2. uni-app 商城移动端」小节，将 "),_("code",[t._v("yudao-mall-uniapp")]),t._v(" 商城项目跑起来。")],1),t._v(" "),_("p",[t._v("② 下载 "),_("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信开发者工具"),_("OutboundLink")],1),t._v("，并进行安装。安装后，选择「公众号网页项目」。如下图所示：")]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%BD%91%E9%A1%B5%E9%A1%B9%E7%9B%AE.png",alt:"公众号网页项目"}})]),t._v(" "),_("h3",{attrs:{id:"_2-2-微信-jssdk"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-微信-jssdk"}},[t._v("#")]),t._v(" 2.2 微信 JSSDK")]),t._v(" "),_("p",[t._v("访问 "),_("code",[t._v("http://127.0.0.1:3000/")]),t._v(" 地址（其它地址也可以），它会触发 "),_("a",{attrs:{href:"https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信 JSSDK"),_("OutboundLink")],1),t._v(" 初始化的逻辑，对应前端 "),_("code",[t._v("sheep/libs/sdk-h5-weixin.js")]),t._v(" 文件的 "),_("code",[t._v("#init(...)")]),t._v(" 方法中。")]),t._v(" "),_("p",[t._v("微信 JSSDK 所需要的签名，由后端的 AppAuthController 的 "),_("code",[t._v("#createWeixinMpJsapiSignature(...)")]),t._v(" 方法所提供。")]),t._v(" "),_("h3",{attrs:{id:"_2-3-登录流程"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-登录流程"}},[t._v("#")]),t._v(" 2.3 登录流程")]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("友情提示：")]),t._v(" "),_("p",[t._v("可以简单阅读下 "),_("a",{attrs:{href:"https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("《微信官方文档 —— 网页授权》"),_("OutboundLink")],1),t._v(" 文章。")])]),t._v(" "),_("p",[t._v("① 访问 "),_("code",[t._v("http://127.0.0.1:3000/#/pages/user/info")]),t._v(" 地址，触发弹出“登录窗口”，对应前端 "),_("code",[t._v("sheep/components/s-auth-modal/s-auth-modal.vue")]),t._v(" 组件。如下图所示：")]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/%E7%99%BB%E5%BD%95%E5%BC%B9%E7%AA%97.png",alt:"登录弹窗"}})]),t._v(" "),_("p",[t._v("② 点击「微信登录」图标，触发微信公众号登录。前端核心实现都在 "),_("code",[t._v("sheep/platform/provider/wechat/officialAccount.js")]),t._v(" 的 "),_("code",[t._v("#login(...)")]),t._v(" 方法中。它一共包含 2 个步骤。")]),t._v(" "),_("p",[t._v("③ 【第一步】前端调用后端的 AppAuthController 的 "),_("code",[t._v("#socialAuthRedirect(...)")]),t._v(" 方法，获得微信公众号的登录地址，并进行跳转。效果如下图：")]),t._v(" "),_("p",[_("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E7%9A%84%E7%99%BB%E5%BD%95%E5%9C%B0%E5%9D%80.png",alt:"微信公众号的登录地址"}})]),t._v(" "),_("p",[t._v("ps：为了在微信登录成功后，可以回到登陆前的 URL 地址，会将该 URL 存储到 "),_("code",[t._v("uni.setStorageSync('returnUrl', location.href)")]),t._v(" 中。")]),t._v(" "),_("p",[t._v("④ 【第二步】点击「同意」按钮，跳转回前端的 "),_("code",[t._v("pages/index/login.vue")]),t._v(" 页面，进行 "),_("strong",[t._v("真正的")]),t._v(" 微信登录逻辑。")]),t._v(" "),_("p",[t._v("此时，前端从 URL 中解析到微信回调提供的 "),_("code",[t._v("code")]),t._v(" 授权码参数，调用后端的 AppAuthController 的 "),_("code",[t._v("#socialLogin(...)")]),t._v(" 方法，进行登录逻辑。注意：")]),t._v(" "),_("ul",[_("li",[t._v("情况一：如果该微信用户已经绑定会员用户，则直接进行登录")]),t._v(" "),_("li",[t._v("情况二：如果该微信用户没有绑定会员用户，则会自动创建一个会员用户，并进行登录。下次重新登录时，就走【情况一】的逻辑。")])]),t._v(" "),_("p",[t._v("ps：登录成功后，通过 "),_("code",[t._v("uni.getStorageSync('returnUrl')")]),t._v(" 获得登录前的 URL 地址，进行跳转。")])])}),[],!1,null,null,null);_.default=a.exports}}]);