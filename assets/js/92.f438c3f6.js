(window.webpackJsonp=window.webpackJsonp||[]).push([[92],{420:function(t,e,v){"use strict";v.r(e);var o=v(7),r=Object(o.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("前置阅读文章：")]),t._v(" "),e("ul",[e("li",[e("RouterLink",{attrs:{to:"/user-center/"}},[t._v("《用户体系》")])],1),t._v(" "),e("li",[e("RouterLink",{attrs:{to:"/social-user/"}},[t._v("《三方登录》")])],1)])]),t._v(" "),e("p",[t._v("本文是 "),e("RouterLink",{attrs:{to:"/social-user/"}},[t._v("《三方登录》")]),t._v(" 的延伸，讲解 "),e("a",{attrs:{href:"https://github.com/yudaocode/yudao-mall-uniapp",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("yudao-mall-uniapp")]),e("OutboundLink")],1),t._v(" 商城小程序如何实现微信 "),e("strong",[t._v("小程序")]),t._v(" 登录的功能。")],1),t._v(" "),e("h2",{attrs:{id:"_1-小程序准备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-小程序准备"}},[t._v("#")]),t._v(" 1. 小程序准备")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("友情提示：")]),t._v(" "),e("p",[t._v("本文，我们以“测试小程序”举例子，方便大家操作，认证一个小程序太难了！！！")])]),t._v(" "),e("p",[t._v("① 参考 "),e("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/devtools/sandbox.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信小程序测试号申请"),e("OutboundLink")],1),t._v(" 链接，申请一个测试小程序。")]),t._v(" "),e("p",[t._v("② 将 "),e("code",[t._v("AppID")]),t._v(" 和 "),e("code",[t._v("AppSecret")]),t._v(" 配置，设置到后端项目 "),e("code",[t._v("application-local.yaml")]),t._v(" 的 "),e("code",[t._v("wx.miniapp")]),t._v(" 配置项中。如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/%E6%B5%8B%E8%AF%95%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%AF%86%E9%92%A5.png",alt:"测试小程序 - 密钥"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E9%A1%B9.png",alt:" 配置项"}})]),t._v(" "),e("p",[t._v("③ 使用 HBuilder 打开 "),e("code",[t._v("yudao-mall-uniapp")]),t._v(" 项目根目录的 "),e("code",[t._v("manifest.json")]),t._v(" 文件，将微信小程序配置的 AppID 改成你自己的。如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/%E9%85%8D%E7%BD%AE%E5%B0%8F%E7%A8%8B%E5%BA%8F.png",alt:"配置小程序"}})]),t._v(" "),e("h2",{attrs:{id:"_2-代码实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-代码实现"}},[t._v("#")]),t._v(" 2. 代码实现")]),t._v(" "),e("h3",{attrs:{id:"_2-1-项目启动"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-项目启动"}},[t._v("#")]),t._v(" 2.1 项目启动")]),t._v(" "),e("p",[t._v("① 下载 "),e("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信开发者工具"),e("OutboundLink")],1),t._v("，并进行安装。")]),t._v(" "),e("p",[t._v("② 参考 "),e("RouterLink",{attrs:{to:"/quick-start-front/"}},[t._v("《快速启动【前端】》")]),t._v(" 文档的「2. uni-app 商城移动端」小节，将 "),e("code",[t._v("yudao-mall-uniapp")]),t._v(" 商城项目跑起来。")],1),t._v(" "),e("p",[t._v("不过要注意，HBuilder 运行时，选择「微信开发者工具」。如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7%E8%BF%90%E8%A1%8C.png",alt:"微信开发者工具运行"}})]),t._v(" "),e("p",[t._v("③ 运行成功后，可以在微信开发者工具中，看到如下界面：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/%E5%95%86%E5%9F%8E%E9%A6%96%E9%A1%B5.png",alt:"商城首页"}})]),t._v(" "),e("p",[t._v("如果请求报错，注意勾选下“不校验合法域名、web-view（业务域名）”选项。")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("补充说明：如果你是正式的小程序，需要额外看下这部分的内容：")]),t._v(" "),e("p",[t._v("① 在小程序的 [管理 -> 成员管理] 菜单，添加自己微信号为开发者。如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/%E6%B7%BB%E5%8A%A0%E5%BC%80%E5%8F%91%E8%80%85%E6%88%90%E5%91%98.png",alt:"添加开发者成员"}})]),t._v(" "),e("p",[t._v("否则，使用 HBuilder 运行时，会报“[微信小程序开发者工具] [error] Error: Fail to open IDE”！")])]),t._v(" "),e("h3",{attrs:{id:"_2-2-登录流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-登录流程"}},[t._v("#")]),t._v(" 2.2 登录流程")]),t._v(" "),e("p",[t._v("① 点击「我的」菜单，再随便点个子菜单，例如说“拼团订单”，触发弹出“登录窗口”，对应前端 "),e("code",[t._v("sheep/components/s-auth-modal/s-auth-modal.vue")]),t._v(" 组件。如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/%E7%99%BB%E5%BD%95%E5%BC%B9%E7%AA%97.png",alt:"登录弹窗"}})]),t._v(" "),e("p",[t._v("有两种登录方式："),e("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信小程序登录"),e("OutboundLink")],1),t._v("、"),e("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("手机快速验证登录"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("② 方式一：【微信小程序登录】点击「微信登录」图标，触发微信小程序登录。前端核心实现都在 "),e("code",[t._v("sheep/platform/provider/wechat/miniProgram.js")]),t._v(" 的 "),e("code",[t._v("#login(...)")]),t._v(" 方法中。")]),t._v(" "),e("p",[t._v("此时，前端调用微信小程序获得“临时” "),e("code",[t._v("code")]),t._v(" 授权码参数，之后调用后端的 AppAuthController 的 "),e("code",[t._v("#socialLogin(...)")]),t._v(" 方法，进行登录逻辑。注意：")]),t._v(" "),e("ul",[e("li",[t._v("情况一：如果该微信用户已经绑定会员用户，则直接进行登录")]),t._v(" "),e("li",[t._v("情况二：如果该微信用户没有绑定会员用户，则会自动创建一个会员用户，并进行登录。下次重新登录时，就走【情况一】的逻辑。")])]),t._v(" "),e("p",[t._v("之后，会弹出“授权信息”窗口，对应 "),e("code",[t._v("sheep/components/s-auth-modal/components/mp-authorization.vue")]),t._v(" 组件。如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E4%BC%9A%E5%91%98%E6%89%8B%E5%86%8C/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/%E6%8E%88%E6%9D%83%E4%BF%A1%E6%81%AF.png",alt:"授权信息"}})]),t._v(" "),e("ul",[e("li",[t._v("注意：该弹窗仅仅用于微信小程序的昵称、头像的获取，用户实际已经登录成功了。")])]),t._v(" "),e("p",[t._v("③ 方式二：【手机快速验证登录】点击「快捷登录」按钮，触发一键登录。前端核心实现都在 "),e("code",[t._v("sheep/platform/provider/wechat/miniProgram.js")]),t._v(" 的 "),e("code",[t._v("#mobileLogin(...)")]),t._v(" 方法中。")]),t._v(" "),e("p",[t._v("此时，前端调用用微信小程序获得“临时” "),e("code",[t._v("code")]),t._v(" 授权参数 + “手机” "),e("code",[t._v("code")]),t._v(" 授权参数，之后调用后端的 AppAuthController 的 "),e("code",[t._v("#weixinMiniAppLogin(...)")]),t._v(" 方法，进行登录逻辑。注意：")]),t._v(" "),e("ul",[e("li",[t._v("情况一：如果该手机已经注册用户，则直接进行登录")]),t._v(" "),e("li",[t._v("情况二：如果该手机没有注册用户，则会自动创建一个会员用户，并进行登录。下次重新登录时，就走【情况一】的逻辑。")])]),t._v(" "),e("p",[t._v("为什么此时要获得“临时” "),e("code",[t._v("code")]),t._v(" 授权参数呢？主要想把微信小程序的 "),e("code",[t._v("openid")]),t._v(" 和用户绑定起来，毕竟方式二【手机快速验证登录】是需要收费的！！！")])])}),[],!1,null,null,null);e.default=r.exports}}]);