(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{380:function(t,a,s){"use strict";s.r(a);var e=s(7),r=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("yudao-spring-boot-starter-protection")]),a("OutboundLink")],1),t._v(" 技术组件，由它的 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/ratelimiter/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("ratelimiter")]),a("OutboundLink")],1),t._v(" 包，提供声明式的限流特性，可防止请求过多。例如说，用户疯狂的点击了某个按钮，导致发送了大量的请求。")]),t._v(" "),a("div",{staticClass:"language-Java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RateLimiter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timeUnit "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TimeUnit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MINUTES")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PostMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/user/create"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    userService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"添加成功"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ul",[a("li",[t._v("每分钟，所有用户，只能操作 10 次")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("疑问：如果想按照每个用户，或者每个 IP，限制请求呢？")]),t._v(" "),a("p",[t._v("可设置该注解的 "),a("code",[t._v("keyResolver")]),t._v(" 属性，可选择的有：")]),t._v(" "),a("ul",[a("li",[t._v("DefaultRateLimiterKeyResolver：全局级别")]),t._v(" "),a("li",[t._v("UserRateLimiterKeyResolver：用户 ID 级别")]),t._v(" "),a("li",[t._v("ClientIpRateLimiterKeyResolver：用户 IP 级别")]),t._v(" "),a("li",[t._v("ServerNodeRateLimiterKeyResolver：服务器 Node 级别")]),t._v(" "),a("li",[t._v("ExpressionIdempotentKeyResolver：自定义级别，通过 "),a("code",[t._v("keyArg")]),t._v(" 属性指定 Spring EL 表达式")])])]),t._v(" "),a("h2",{attrs:{id:"_1-实现原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-实现原理"}},[t._v("#")]),t._v(" 1. 实现原理")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("友情提示：")]),t._v(" "),a("p",[t._v("它的实现原理，和 "),a("RouterLink",{attrs:{to:"/idempotent/"}},[t._v("《幂等性（防重复提交）》")]),t._v(" 比较接近哈。")],1)]),t._v(" "),a("p",[t._v("它的实现原理非常简单，针对相同参数的方法，一段时间内，只能执行一定次数。执行流程如下：")]),t._v(" "),a("p",[t._v("在方法执行前，判断参数对应的 Key 是否超过限制：")]),t._v(" "),a("ul",[a("li",[t._v("如果"),a("strong",[t._v("超过")]),t._v("，则进行报错。")]),t._v(" "),a("li",[t._v("如果"),a("strong",[t._v("未超过")]),t._v("，则使用 Redis 计数 +1")])]),t._v(" "),a("p",[t._v("默认参数的 Redis Key 的计算规则由 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/ratelimiter/core/keyresolver/impl/DefaultRateLimiterKeyResolver.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("DefaultRateLimiterKeyResolver"),a("OutboundLink")],1),t._v(" 实现，使用 MD5(方法名 + 方法参数)，避免 Redis Key 过长。")]),t._v(" "),a("h2",{attrs:{id:"_2-ratelimiter-注解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-ratelimiter-注解"}},[t._v("#")]),t._v(" 2. "),a("code",[t._v("@RateLimiter")]),t._v(" 注解")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/ratelimiter/core/annotation/RateLimiter.java",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("@RateLimiter")]),a("OutboundLink")],1),t._v(" 注解，声明在方法上，表示该方法需要开启限流。代码如下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81/%E6%B3%A8%E8%A7%A3.png",alt:" 注解"}})]),t._v(" "),a("p",[t._v("① 对应的 AOP 切面是 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/ratelimiter/core/aop/RateLimiterAspect.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("RateLimiterAspect"),a("OutboundLink")],1),t._v(" 类，核心就 10 行左右的代码，如下图所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81/RateLimiterAspect.png",alt:"RateLimiterAspect"}})]),t._v(" "),a("p",[t._v("② 对应的 Redis Key 的前缀是 "),a("code",[t._v("rate_limiter:%")]),t._v(" ，可见 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/ratelimiter/core/redis/RateLimiterRedisDAO.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("IdempotentRedisDAO"),a("OutboundLink")],1),t._v(" 类，如下图所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81/IdempotentRedisDAO.png",alt:"IdempotentRedisDAO 存储"}})]),t._v(" "),a("h2",{attrs:{id:"_3-使用示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用示例"}},[t._v("#")]),t._v(" 3. 使用示例")]),t._v(" "),a("p",[t._v("本小节，我们实现 "),a("code",[t._v("/admin-api/system/user/page")]),t._v(" RESTful API 接口的限流。")]),t._v(" "),a("p",[t._v("① 在 "),a("code",[t._v("pom.xml")]),t._v(" 文件中，引入 "),a("code",[t._v("yudao-spring-boot-starter-protection")]),t._v(" 依赖。")]),t._v(" "),a("div",{staticClass:"language-XML extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("cn.iocoder.boot"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("yudao-spring-boot-starter-protection"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("② 在 "),a("code",[t._v("/admin-api/system/user/page")]),t._v(" RESTful API 接口的对应方法上，添加 "),a("code",[t._v("@RateLimiter")]),t._v(" 注解。代码如下：")]),t._v(" "),a("div",{staticClass:"language-Java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// UserController.java")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/page"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RateLimiter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" time "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommonResult")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PageResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserRespVO")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserPage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Valid")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserPageReqVO")]),t._v(" pageReqVO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ... 省略代码")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("③ 调用该 API 接口，执行成功。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81/%E6%A1%88%E4%BE%8B.png",alt:"调用成功"}})]),t._v(" "),a("p",[t._v("④ 再次调用该 API 接口，被限流拦截，执行失败。")]),t._v(" "),a("div",{staticClass:"language-JSON extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"code"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("429")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"data"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token null keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"请求过于频繁，请稍后重试"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);