(window.webpackJsonp=window.webpackJsonp||[]).push([[137],{466:function(s,t,a){"use strict";a.r(t);var e=a(7),r=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("数据权限，由 "),t("code",[s._v("yudao-module-crm-biz")]),s._v(" 后端模块的 "),t("code",[s._v("permission")]),s._v(" 包实现，支持某个人对某个数据（线索、客户、商机、合同等等），有对应的权限。")]),s._v(" "),t("p",[s._v("目前权限由 CrmPermissionLevelEnum 枚举，包括 3 种："),t("code",[s._v("OWNER")]),s._v("（负责人）、"),t("code",[s._v("WRITE")]),s._v("（读写）、"),t("code",[s._v("READ")]),s._v("（只读），并且 "),t("code",[s._v("OWNER > WRITE > READ")]),s._v("。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("友情提示：")]),s._v(" "),t("p",[s._v("为什么不使用全局封装的 [《数据权限》])(/data-permission) 呢？")]),s._v(" "),t("p",[s._v("目前 CRM 系统的数据权限比较灵活，部分功能无法很好的支持。例如说：")]),s._v(" "),t("ul",[t("li",[s._v("全局的数据权限，只支持对某个数据的操作权限，而 CRM 需要分 OWNER、WRITE、READ 三种权限")]),s._v(" "),t("li",[s._v("全局的数据全量，对关联数据的权限控制，无法很好的支持。例如说：对某个客户有 WRITE 权限时，可以 WRITE 它下面的联系人、商机、合同等等")])]),s._v(" "),t("p",[s._v("你可以理解全局的数据权限是基于 DB（DAO）层面实现的，而 CRM 的数据权限是基于 Service 层面实现的。")])]),s._v(" "),t("h2",{attrs:{id:"_1-表结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-表结构"}},[s._v("#")]),s._v(" 1. 表结构")]),s._v(" "),t("blockquote",[t("p",[s._v("省略 creator/create_time/updater/update_time/deleted/tenant_id 等通用字段")])]),s._v(" "),t("div",{staticClass:"language-SQL extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("crm_permission"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("bigint")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AUTO_INCREMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'编号'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("user_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("bigint")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'用户编号'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  \n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("biz_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tinyint")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'100'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'数据类型'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("biz_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("bigint")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'数据编号'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  \n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("level"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'会员等级'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USING")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BTREE")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("InnoDB")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AUTO_INCREMENT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("86")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARSET")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8mb4 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COLLATE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8mb4_unicode_ci "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'CRM 数据权限表'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("基本就是三要素：")]),s._v(" "),t("ul",[t("li",[s._v("人："),t("code",[s._v("user_id")]),s._v(" 字段")]),s._v(" "),t("li",[s._v("数据："),t("code",[s._v("biz_type")]),s._v(" + "),t("code",[s._v("biz_id")]),s._v(" 字段。其中 "),t("code",[s._v("biz_type")]),s._v(" 由 CrmBizTypeEnum 枚举，包括线索、客户、联系人、商机、合同、回款等等")]),s._v(" "),t("li",[s._v("权限："),t("code",[s._v("level")]),s._v(" 字段。由 CrmPermissionLevelEnum 枚举，包括 "),t("code",[s._v("OWNER")]),s._v("、"),t("code",[s._v("WRITE")]),s._v("、"),t("code",[s._v("READ")]),s._v(" 三种")])]),s._v(" "),t("h3",{attrs:{id:"_1-1-owner-负责人"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-owner-负责人"}},[s._v("#")]),s._v(" 1.1 "),t("code",[s._v("OWNER")]),s._v(" 负责人")]),s._v(" "),t("p",[s._v("① 每个数据在新增时，会插入一条 "),t("code",[s._v("OWNER")]),s._v(" 的权限。例如说，新增一个客户，会插入一条 "),t("code",[s._v("OWNER")]),s._v(" 的权限。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E6%96%B0%E5%A2%9E-%E8%B4%9F%E8%B4%A3%E4%BA%BA.png",alt:"新增 OWNER 负责人（代码）"}})]),s._v(" "),t("p",[s._v("② 每个数据在转移时，会对新、老负责人的权限做不同的处理。例如说，联系人转移给其他人，会更新对应的权限。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E8%BD%AC%E7%A7%BB-%E8%B4%9F%E8%B4%A3%E4%BA%BA.png",alt:"转移 OWNER 负责人（界面）"}})]),s._v(" "),t("ul",[t("li",[s._v("老负责人，会将对应的 "),t("code",[s._v("crm_permission")]),s._v(" 的 "),t("code",[s._v("level")]),s._v(" 更新为 "),t("code",[s._v("READ")])]),s._v(" "),t("li",[s._v("新负责人，会插入一条 "),t("code",[s._v("OWNER")]),s._v(" 的权限")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E8%BD%AC%E7%A7%BB-%E8%B4%9F%E8%B4%A3%E4%BA%BA2.png",alt:"转移 OWNER 负责人（代码）"}})]),s._v(" "),t("h3",{attrs:{id:"_1-2-write-读写、read-只读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-write-读写、read-只读"}},[s._v("#")]),s._v(" 1.2 "),t("code",[s._v("WRITE")]),s._v(" 读写、"),t("code",[s._v("READ")]),s._v(" 只读")]),s._v(" "),t("p",[s._v("在每个数据的详情界面，有一个 [团队成员] 的功能，可以查看当前数据的权限，同时可以修改 "),t("code",[s._v("WRITE")]),s._v(" 和 "),t("code",[s._v("READ")]),s._v(" 的权限。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E6%96%B0%E5%A2%9E-%E8%AF%BB%E5%86%99.png",alt:"新增读写权限（界面）"}})]),s._v(" "),t("p",[s._v("这是一个通用的功能，不需要每个数据都实现一遍，在 CrmPermissionController 已经统一实现。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E6%96%B0%E5%A2%9E-%E8%AF%BB%E5%86%992.png",alt:"新增读写权限（代码）"}})]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("友情提示：为什么转移负责人不能在 CrmPermissionController 统一实现呢？")]),s._v(" "),t("p",[s._v("考虑到查询方便，每个数据记录自身会有 "),t("code",[s._v("owner_user_id")]),s._v(" 字段，转移时需要更新，所以没一起实现。")])]),s._v(" "),t("h2",{attrs:{id:"_3-后端实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-后端实现"}},[s._v("#")]),s._v(" 3. 后端实现")]),s._v(" "),t("h3",{attrs:{id:"_2-1-操作校验"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-操作校验"}},[s._v("#")]),s._v(" 2.1 操作校验")]),s._v(" "),t("p",[s._v("操作校验，通过 "),t("code",[s._v("@CrmPermission")]),s._v(" 注解实现，只要添加在 Service 方法上，即可实现对应的权限校验。")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CrmPermission%E6%B3%A8%E8%A7%A3.png",alt:"CrmPermission 注解"}})]),s._v(" "),t("p",[s._v("① 使用示例，如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CrmPermission%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B.png",alt:"CrmPermission 注解使用示例"}})]),s._v(" "),t("p",[s._v("② 通过 Spring AOP 实现，可见 CrmPermissionAspect 类，如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CrmPermissionAspect%E7%B1%BB.png",alt:"CrmPermissionAspect 类"}})]),s._v(" "),t("p",[s._v("通过这个类，我们也可以看出为什么要有 "),t("code",[s._v("crm_permission")]),s._v(" 表。如果没有这个表，我们需要查询每个业务的数据，通过它们的字段，判断当前用户是否有权限，这样拓展性比较差。")]),s._v(" "),t("p",[s._v("③ 【CRM 管理员】的角色枚举是 "),t("code",[s._v("crm_admin")]),s._v("，它和全局的【超级管理员】 "),t("code",[s._v("super_admin")]),s._v(" 是分开的。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CRM%E7%AE%A1%E7%90%86%E5%91%98.png",alt:"CRM 管理员"}})]),s._v(" "),t("p",[s._v("也就是说，把【CRM 管理员】分配给某个人时，可以查询和操作所有 CRM 的数据。")]),s._v(" "),t("h3",{attrs:{id:"_2-2-查询过滤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-查询过滤"}},[s._v("#")]),s._v(" 2.2 查询过滤")]),s._v(" "),t("p",[s._v("在数据的列表界面，我们需要在 DB 数据库查询的时候，就将没有 "),t("code",[s._v("READ")]),s._v(" 权限的数据过滤掉。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("疑问：为什么不通过类似 `@CrmPermission` 注解实现呢？")]),s._v(" "),t("p",[s._v("可以实现，但是会查询特别多没权限的数据到内存中，导致性能比较差。")])]),s._v(" "),t("p",[s._v("这个无法通用实现，目前是每个业务 Mapper 拼接 SQL 实现，通过联表查询 "),t("code",[s._v("crm_permission")]),s._v(" 表，进行过滤。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%9F%A5%E8%AF%A2%E8%BF%87%E6%BB%A4.png",alt:"查询过滤"}})]),s._v(" "),t("p",[s._v("核心的拼接逻辑在 CrmPermissionUtils 的 "),t("code",[s._v("#appendPermissionCondition(...)")]),s._v(" 方法里，不是很复杂，可以自己瞅瞅。如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CrmPermissionUtils%E7%B1%BB.png",alt:"appendPermissionCondition 方法"}})]),s._v(" "),t("p",[s._v("另外，CRM 系统的所有管理界面，都有一个 CrmSceneTypeEnum 枚举，分成 3 种场景："),t("code",[s._v("OWNER")]),s._v(" 我负责的，"),t("code",[s._v("INVOLVED")]),s._v(" 我参与的、"),t("code",[s._v("SUBORDINATE")]),s._v(" 下属负责的，也是通过上面查询实现的。")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CRM%E5%9C%BA%E6%99%AF.png",alt:"CRM 场景"}})]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("画外音")]),s._v(" "),t("p",[s._v("看到这里，在回过头看为什么不基于全局的 [《数据权限》])(/data-permission) 实现，是不是有点明白了呢？")]),s._v(" "),t("p",[s._v("在设计系统的数据权限，我们总是渴望通过全局的、自动化的方式实现。但是，实际上，业务的数据权限是非常复杂的，很难通过全局的方式实现。")]),s._v(" "),t("p",[s._v("因此，我们需要在业务层面，实现对应的数据权限逻辑。嘿嘿~")])])])}),[],!1,null,null,null);t.default=r.exports}}]);